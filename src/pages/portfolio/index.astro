---
import { getCollection } from "astro:content";
import ImgHeaderPortfolio from "../../assets/header/headerPortfolio.jpg";
import PixelarticonsBriefcase from "../../components/icons/PixelarticonsBriefcase.astro";
import PixelarticonsHumanHandsup from "../../components/icons/PixelarticonsHumanHandsup.astro";
import PixelarticonsScriptText from "../../components/icons/PixelarticonsScriptText.astro";
import SidebarBase from "../../components/navigation/SidebarBase.astro";
import PageHeaderImg from "../../components/PageHeaderImg.astro";
import PortfolioIndexGrid from "../../components/portfolio/PortfolioIndexGrid.astro";
import LayoutBase from "../../layouts/LayoutBase.astro";

const locale = (Astro.currentLocale as "en" | "sv") ?? "en";

const allPortfolioEntries = await getCollection(
  "portfolioCollection",
  ({ id, data }) => {
    return id.startsWith(`${locale}/`) && !data.draft;
  },
);

const portfolioStats = {
  longestArticle: allPortfolioEntries.reduce((longest, entry) => {
    const currentLength = entry.body?.length || 0;
    const longestLength = longest.body?.length || 0;
    return currentLength > longestLength ? entry : longest;
  }, allPortfolioEntries[0]),

  mostRecentProject: allPortfolioEntries
    .sort((a, b) => a.data.publishedDate.localeCompare(b.data.publishedDate))
    .reverse()[0],
};

const stats = [
  {
    label: "Projects showcased",
    value: allPortfolioEntries.length.toString(),
    Icon: PixelarticonsBriefcase,
  },
  {
    label: "Longest project article",
    value: `${Math.ceil((portfolioStats.longestArticle?.body?.length || 0) / 250)}k`,
    Icon: PixelarticonsScriptText,
  },
  {
    label: "Most recent project",
    value: portfolioStats.mostRecentProject?.data.title || "N/A",
    Icon: PixelarticonsHumanHandsup,
  },
];
---

<LayoutBase>
  <SidebarBase showLogo showReturn slot="sidebar">
    <div slot="content">
      <aside class="space-y-4 text-xs text-stone-500">
        {
          stats.map((stat) => (
            <div class="space-y-0.5">
              <span class="mb-1 flex items-center gap-1">
                <stat.Icon aria-hidden="true" class="h-4 w-4" />
                {stat.label}
              </span>
              <span class="font-mono text-stone-800 dark:text-stone-300">
                {stat.value}
              </span>
            </div>
          ))
        }
      </aside>
    </div>
  </SidebarBase>

  <div slot="content" class="space-y-12">
    <PageHeaderImg
      headerImgSrc={ImgHeaderPortfolio}
      headerImgAlt="Picture of William Hallin"
      headingText="Work Showcase"
      headingItalic={false}
      descriptionText="All my most proudest work â€” collected in one place. Explore each project, the process behind it, and the final results."
      btnText="Start your project"
      btnHref="/hire"
      btnAriaLabel="Start your project on the hire page"
    />

    <PortfolioIndexGrid />
  </div>
</LayoutBase>
